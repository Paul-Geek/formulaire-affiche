<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>G√©n√©rateur de Bulletins de Vote</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    /* --- CSS Vanilla optimis√© WordPress/Elementor --- */
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 20px;
    }
    .wp-ballot-generator {
      max-width: 900px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }
    input, textarea, select, button {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }
    textarea {
      min-height: 80px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      background: #0056b3;
    }
    #ballotPreview {
      margin-top: 20px;
      text-align: center;
    }
    #ballot {
      background: white;
      border: 2px solid #ccc;
      margin: auto;
      position: relative;
      overflow: hidden;
      width: 400px;
      height: 280px;
    }
    #ballotImage {
      position: absolute;
      cursor: move;
      user-select: none;
    }
    .resize-handle {
      width: 12px;
      height: 12px;
      background: #007bff;
      border-radius: 50%;
      position: absolute;
      bottom: -6px;
      right: -6px;
      cursor: se-resize;
    }
    .crop-marks .crop-mark {
      position: absolute;
      background: black;
    }
    .crop-marks .crop-mark.horizontal {
      width: 15mm;
      height: 1px;
    }
    .crop-marks .crop-mark.vertical {
      width: 1px;
      height: 15mm;
    }
    .bleed-area {
      position: absolute;
      top: -3mm;
      left: -3mm;
      right: -3mm;
      bottom: -3mm;
      border: 1px dashed red;
      pointer-events: none;
    }
  </style>
</head>
<body>

<div class="wp-ballot-generator">
  <h1>G√©n√©rateur de Bulletins</h1>

  <div class="form-group">
    <label for="municipalCandidates">Liste des candidats (1 par ligne)</label>
    <textarea id="municipalCandidates"></textarea>
  </div>

  <div class="form-group">
    <label for="logoUpload">Importer un logo</label>
    <input type="file" id="logoUpload" accept="image/*">
  </div>

  <div id="formatInfo" class="hidden form-group">
    Format recommand√© : <span id="formatText"></span>
  </div>

  <div class="form-group">
    <button onclick="generatePDF()">üìÑ G√©n√©rer PDF</button>
    <button onclick="printBallot()">üñ®Ô∏è Imprimer</button>
    <button onclick="resetForm()">‚ôªÔ∏è R√©initialiser</button>
  </div>

  <div id="ballotPreview">
    <div id="ballot"></div>
  </div>
</div>

<script>
let isDragging = false;
let isResizing = false;
let dragOffset = { x: 0, y: 0 };
let resizeStartSize = { width: 0, height: 0 };
let resizeStartPos = { x: 0, y: 0 };

document.getElementById("logoUpload").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = evt => addImageToBallot(evt.target.result);
  reader.readAsDataURL(file);
});

function addImageToBallot(src) {
  const ballot = document.getElementById("ballot");
  ballot.innerHTML = ""; // reset preview
  const img = document.createElement("img");
  img.id = "ballotImage";
  img.src = src;
  img.onload = () => setupImage(img);
  ballot.appendChild(img);
}

function setupImage(img) {
  const naturalRatio = img.naturalWidth / img.naturalHeight;
  const baseWidth = 100;
  const proportionalHeight = Math.round(baseWidth / naturalRatio);
  img.style.width = baseWidth + "px";
  img.style.height = proportionalHeight + "px";
  img.style.left = "20px";
  img.style.top = "20px";

  const resizeHandle = document.createElement("div");
  resizeHandle.className = "resize-handle";
  resizeHandle.id = "resizeHandle";
  document.getElementById("ballot").appendChild(resizeHandle);

  img.addEventListener("mousedown", startDrag);
  resizeHandle.addEventListener("mousedown", startResize);
  updateResizeHandlePosition();
}

function updateResizeHandlePosition() {
  const img = document.getElementById("ballotImage");
  const handle = document.getElementById("resizeHandle");
  if (img && handle) {
    handle.style.left = img.offsetLeft + img.offsetWidth - 10 + "px";
    handle.style.top = img.offsetTop + img.offsetHeight - 10 + "px";
  }
}

function startDrag(e) {
  if (isResizing) return;
  isDragging = true;
  const img = e.target;
  dragOffset.x = e.clientX - img.getBoundingClientRect().left;
  dragOffset.y = e.clientY - img.getBoundingClientRect().top;
  document.addEventListener("mousemove", drag);
  document.addEventListener("mouseup", stopDrag);
  e.preventDefault();
}
function drag(e) {
  if (!isDragging) return;
  const img = document.getElementById("ballotImage");
  const ballot = document.getElementById("ballot");
  let newX = e.clientX - ballot.getBoundingClientRect().left - dragOffset.x;
  let newY = e.clientY - ballot.getBoundingClientRect().top - dragOffset.y;
  newX = Math.max(0, Math.min(newX, ballot.offsetWidth - img.offsetWidth));
  newY = Math.max(0, Math.min(newY, ballot.offsetHeight - img.offsetHeight));
  img.style.left = newX + "px";
  img.style.top = newY + "px";
  updateResizeHandlePosition();
}
function stopDrag() {
  isDragging = false;
  document.removeEventListener("mousemove", drag);
  document.removeEventListener("mouseup", stopDrag);
}

function startResize(e) {
  isResizing = true;
  const img = document.getElementById("ballotImage");
  resizeStartSize.width = img.offsetWidth;
  resizeStartSize.height = img.offsetHeight;
  resizeStartPos.x = e.clientX;
  resizeStartPos.y = e.clientY;
  document.addEventListener("mousemove", resize);
  document.addEventListener("mouseup", stopResize);
  e.preventDefault();
}
function resize(e) {
  if (!isResizing) return;
  const img = document.getElementById("ballotImage");
  const deltaX = e.clientX - resizeStartPos.x;
  const aspectRatio = resizeStartSize.width / resizeStartSize.height;
  let newWidth = resizeStartSize.width + deltaX;
  let newHeight = newWidth / aspectRatio;
  img.style.width = Math.max(30, newWidth) + "px";
  img.style.height = Math.max(30, newHeight) + "px";
  updateResizeHandlePosition();
}
function stopResize() {
  isResizing = false;
  document.removeEventListener("mousemove", resize);
  document.removeEventListener("mouseup", stopResize);
}

async function generatePDF() {
  const ballot = document.getElementById("ballot");
  const canvas = await html2canvas(ballot);
  const imgData = canvas.toDataURL("image/png");
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("l", "mm", "a5");
  pdf.addImage(imgData, "PNG", 0, 0, 210, 148);
  pdf.save("bulletin.pdf");
}
function printBallot() {
  window.print();
}
function resetForm() {
  document.getElementById("municipalCandidates").value = "";
  document.getElementById("logoUpload").value = "";
  document.getElementById("ballot").innerHTML = "";
}
</script>

</body>
</html>
